<Project>
  <ItemGroup>
    <UpToDateCheckInput Include="@(Scaffold)" />
  </ItemGroup>

  <UsingTask TaskName="CalculatedScaffold" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <Inputs ParameterType="System.String[]" Required="True" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
        <![CDATA[
foreach (var infile in Inputs)
{
    string outfile = Path.ChangeExtension(infile, ".g.cs");
    Log.LogMessage("{0} -> {1}", infile, outfile);
    using (var input = File.OpenText(infile))
    using (var output = File.CreateText(outfile))
    {
        output.WriteLine(@"//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------");
        output.WriteLine("using System;");
        output.WriteLine("using System.Collections.Generic;");
        output.WriteLine("using Sakuno.KanColle.Amatsukaze.ViewModels;");
        var ns = input.ReadLine();
        output.Write("namespace ");
        output.WriteLine(ns);
        output.WriteLine("{");
        while (!input.EndOfStream)
        {
            var cls = input.ReadLine().Split(':');
            var props = new List<string>();
            var tables = new List<string>();
            var bindables = new List<string>();
            var localizables = new List<string>();
            while (true)
            {
                var line = input.ReadLine();
                int p = line.IndexOf(':');
                if (p < 0) break;
                switch (line.Substring(0, p))
                {
                    case "p":
                        props.Add(line.Substring(p + 1));
                        break;
                    case "t":
                        tables.Add(line.Substring(p + 1));
                        break;
                    case "b":
                        bindables.Add(line.Substring(p + 1));
                        break;
                    case "l":
                        localizables.Add(line.Substring(p + 1));
                        break;
                }
            }
            output.WriteLine("    public partial class " + cls[0] + " : Calculated<" + cls[1] + ">");
            output.WriteLine("    {");
            output.WriteLine("        public " + cls[0] + "(int id, ITableProvider owner) : base(id, owner)");
            output.WriteLine("        {");
            foreach (var t in tables)
            {
                string fieldName = char.ToLowerInvariant(t[0]) + t.Substring(1) + "s";
                output.WriteLine("            " + fieldName + " = owner.GetTable<" + t + ">();");
            }
            output.WriteLine("            CreateDummy();");
            output.WriteLine("        }");
            foreach (var t in tables)
            {
                string fieldName = char.ToLowerInvariant(t[0]) + t.Substring(1) + "s";
                output.WriteLine();
                output.WriteLine("        private readonly ITable<" + t + "> " + fieldName + ";");
            }
            var dummyList = new List<string>();
            foreach (var l in localizables)
            {
                var prop = l.Split(' ');
                output.WriteLine();
                string propName = prop[0];
                string category = prop[1];
                dummyList.Add(propName);
                string fieldName = "_" + char.ToLowerInvariant(propName[0]) + propName.Substring(1);
                output.WriteLine();
                output.WriteLine("        private string " + fieldName + ";");
                output.WriteLine("        public string " + propName);
                output.WriteLine("        {");
                output.WriteLine("            get => " + fieldName + ";");
                output.WriteLine("            private set");
                output.WriteLine("            {");
                output.WriteLine("                if (" + fieldName + " != value)");
                output.WriteLine("                {");
                output.WriteLine("                    " + fieldName + " = value;");
                output.WriteLine("                    NotifyPropertyChanged();");
                output.WriteLine("                    Localized" + propName + " = Module.Localize.GetText(\"" + category + "\", Id.ToString(), value);");
                output.WriteLine("                    NotifyPropertyChanged(nameof(Localized" + propName + "));");
                output.WriteLine("                }");
                output.WriteLine("            }");
                output.WriteLine("        }");
                output.WriteLine("        public LocalizableText " + "Localized" + propName + " { get; private set; }");
            }
            foreach (var line in props)
            {
                var prop = line.Split(' ');
                string propName = prop[1];
                string propType = prop[0];
                string fieldName = "_" + char.ToLowerInvariant(propName[0]) + propName.Substring(1);
                if (prop.Length >= 3 && prop[2] == "-")
                    dummyList.Add(propName);
                output.WriteLine();
                output.WriteLine("        private " + propType + " " + fieldName + ";");
                output.WriteLine("        public " + propType + " " + propName);
                output.WriteLine("        {");
                output.WriteLine("            get => " + fieldName + ";");
                output.WriteLine("            private set => Set(ref " + fieldName + ", value);");
                output.WriteLine("        }");
            }
            output.WriteLine();
            output.WriteLine("        public override void Update(" + cls[1] + " raw)");
            output.WriteLine("        {");
            foreach (string prop in dummyList)
                output.WriteLine("            " + prop + " = raw." + prop + ";");
            output.WriteLine("            UpdateCore(raw);");
            output.WriteLine("        }");
            output.WriteLine("        partial void UpdateCore(" + cls[1] + " raw);");
            output.WriteLine("        partial void CreateDummy();");
            foreach (var b in bindables)
            {
                var prop = b.Split(' ');
                string name = prop[1];
                string type = prop[0];
                string field = char.ToLowerInvariant(name[0]) + name.Substring(1);
                output.WriteLine();
                output.WriteLine("        private readonly BindableSnapshotCollection<" + type + "> " + field + " = new BindableSnapshotCollection<" + type + ">();");
                output.WriteLine("        public IBindableCollection<" + type +"> " + name + " => " + field + ";");
            }
            output.WriteLine("    }");
        }
        output.WriteLine("}");
        output.Flush();
    }
}
        ]]>
      </Code>
    </Task>
  </UsingTask>

  <Target Name="UpdateScaffold" Inputs="$(MSBuildProjectFile);@(Scaffold)" Outputs="@(Scaffold->'%(RelativeDir)%(Filename).g.cs')" BeforeTargets="CoreCompile">
    <CalculatedScaffold Inputs="@(Scaffold)" />
  </Target>
</Project>
